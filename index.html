<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekobin - Smart Recycling Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hero-bg {
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1611270418597-a6c77f4b8a2d?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        /* Custom scrollbar for modals */
        #history-list::-webkit-scrollbar, #vouchers-list::-webkit-scrollbar, #claimed-vouchers-list::-webkit-scrollbar {
            width: 8px;
        }
        #history-list::-webkit-scrollbar-track, #vouchers-list::-webkit-scrollbar-track, #claimed-vouchers-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #history-list::-webkit-scrollbar-thumb, #vouchers-list::-webkit-scrollbar-thumb, #claimed-vouchers-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #history-list::-webkit-scrollbar-thumb:hover, #vouchers-list::-webkit-scrollbar-thumb:hover, #claimed-vouchers-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Added styles for auth page */
        .page-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://images.unsplash.com/photo-1554224154-260325c05b2a?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            filter: blur(8px);
            z-index: -1;
        }
        /* Spinner styles */
         .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f; /* Blue color for spinner */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Z-INDEX FOR OVERLAYS */
        #initial-loading {
             z-index: 110; /* Highest z-index */
        }
        #auth-overlay, #get-started-overlay { /* Overlays */
             z-index: 100;
        }

        #main-content.hidden {
             display: none; /* Use display none instead of just hidden class if needed */
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800">

      <div id="get-started-overlay" class="page-overlay hidden fixed inset-0 flex items-center justify-center p-4">
          <div class="w-full max-w-md bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 text-center">
              <h2 class="text-3xl font-bold text-green-700">Ekobin</h2>
              <p class="text-gray-600 mt-4 text-lg">Welcome to the future of recycling.</p>
              <p class="text-gray-700 my-6">Turn your e-waste into rewards and help us build a cleaner, greener planet.</p>

              <div class="mt-6 mb-8 text-sm text-gray-600 space-y-2">
                   <p class="flex items-center justify-center">
                       <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                       Contact: 9381807364
                   </p>
                   <p class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                        Email: saminderreddy8055@gmail.com
                   </p>
              </div>

              <button id="get-started-btn" class="w-full bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-green-700 transition-colors duration-300 shadow-xl">
                  Get Started
              </button>
         </div>
      </div>
      <div id="initial-loading" class="fixed inset-0 bg-white flex flex-col items-center justify-center">
          <div class="spinner mb-4"></div>
          <p class="text-gray-600">Connecting to service...</p>
      </div>

    <div id="auth-overlay" class="page-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-green-700">Ekobin</h2>
                <p class="text-gray-600 mt-2">Welcome! Please log in or sign up to continue.</p>
            </div>

            <div id="login-form-container">
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <button type="submit" id="login-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">Log In</button>
                </form>
            </div>

            <div id="signup-form-container" class="hidden">
                <form id="signup-form">
                    <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <button type="submit" id="signup-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">Sign Up</button>
                </form>
            </div>

            <div class="text-center mt-4">
                <a href="#" id="toggle-auth-mode" class="text-sm text-green-600 hover:underline">Need an account? Sign Up</a>
            </div>

            <div class="my-6 flex items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-500">OR</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>

            <button id="google-signin-btn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center shadow-sm">
                <svg class="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"></path></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <header class="bg-white shadow-md fixed w-full z-20 top-0">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="#" class="text-2xl font-bold text-green-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 -mt-1" aria-hidden="true"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><path d="M12 14a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"></path><path d="M12 11v2"></path><path d="m10 13 4-4"></path></svg>
                    Ekobin
                </a>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="#home" class="text-gray-600 hover:text-green-600">Home</a>
                    <a href="#about" class="text-gray-600 hover:text-green-600">About</a>
                    <a href="#process" class="text-gray-600 hover:text-green-600">Process</a>
                    <a href="#" id="my-activity-btn" class="text-gray-600 hover:text-green-600">My Activity</a>
                    <a href="#" id="my-rewards-btn" class="text-gray-600 hover:text-green-600 font-semibold">My Rewards</a>
                    <a href="#" id="claimed-vouchers-btn" class="text-gray-600 hover:text-green-600">Claimed</a>
                </div>

                <div class="flex items-center space-x-4">
                        <button id="recycle-now-btn-nav" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors duration-300 shadow-lg">
                            Recycle Now
                        </button>

                        <a href="refurbished.html" title="Refurbished Items" class="p-2 rounded-lg text-gray-600 hover:bg-green-100 hover:text-green-600 transition-colors duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 1v3M10 8l-4 4 4 4M14 8l4 4-4 4M1 12h9M23 12h-9M4 17h16M4 22h16"></path></svg> <span class="sr-only">Refurbished Items</span>
                        </a>

                    <div class="relative">
                        <button id="user-menu-btn" class="p-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6" aria-hidden="true">
                                <line x1="3" y1="12" x2="21" y2="12"></line>
                                <line x1="3" y1="6" x2="21" y2="6"></line>
                                <line x1="3" y1="18" x2="21" y2="18"></line>
                            </svg>
                            <span class="sr-only">Open User Menu</span>
                        </button>

                        <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg py-1 z-30 border border-gray-200">
                            <div id="user-email-display" class="hidden px-4 py-3" title="Your Email">
                                <p class="text-sm text-gray-500">Signed in as:</p>
                                <p id="user-email-text" class="text-sm text-gray-700 font-semibold truncate">user@example.com</p>
                            </div>
                            <div class="border-t border-gray-100"></div>
                            <a href="admin.html" id="admin-link" title="Admin Dashboard" class="hidden w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 hover:text-blue-700 transition-colors duration-200 flex items-center space-x-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5" aria-hidden="true">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                <span>Admin Dashboard</span>
                            </a>
                            <button id="logout-btn" title="Logout" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 transition-colors duration-200 flex items-center space-x-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5" aria-hidden="true">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                                <span>Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <main>
            <section id="home" class="hero-bg text-white pt-32 pb-20">
                <div class="container mx-auto px-6 text-center">
                    <h1 class="text-4xl md:text-6xl font-bold mb-4 leading-tight">Turn Your E-Waste into a Greener Planet</h1>
                    <p class="text-lg md:text-xl text-gray-200 mb-8 max-w-3xl mx-auto">Join us in responsibly recycling your old electronics. Schedule a free pickup, track the process, and earn rewards for making a sustainable choice.</p>
                    <button id="recycle-now-btn-hero" class="bg-white text-green-700 font-bold py-3 px-8 rounded-full text-lg hover:bg-gray-100 transition-transform transform hover:scale-105 duration-300 shadow-2xl">
                        Schedule a Free Pickup
                    </button>
                </div>
            </section>

             <section id="about" class="py-20 bg-white">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold text-gray-800">The Growing Problem of E-Waste</h2>
                        <p class="text-gray-600 mt-2 max-w-2xl mx-auto">Millions of tons of electronics end up in landfills, polluting our environment with toxic materials and wasting valuable resources.</p>
                    </div>
                    <div class="flex flex-col md:flex-row items-center gap-10">
                        <div class="md:w-1/2 flex flex-col items-center justify-center bg-gray-100 rounded-lg shadow-xl p-8">
                            <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-green-500" aria-hidden="true"><path d="M12 2v4"></path><path d="M16 4.01l2.39 1.19"></path><path d="M18.81 9l1.19 2.39"></path><path d="M22 12h-4"></path><path d="M18.81 15l-1.19 2.39"></path><path d="M16 19.99l-2.39 1.19"></path><path d="M12 22v-4"></path><path d="M8.01 19.99l-2.39-1.19"></path><path d="M5.19 15l-1.19-2.39"></path><path d="M2 12h4"></path><path d="M5.19 9l1.19-2.39"></path><path d="M8.01 4.01l2.39-1.19"></path><path d="M17 8h-2l-2.5 4 2.5 4h2Z"></path><path d="M7 8h2l2.5 4-2.5 4H7Z"></path></svg>
                            <blockquote class="mt-6 text-center text-gray-600 italic">
                                "We do not inherit the Earth from our ancestors; we borrow it from our children."
                                <cite class="block not-italic mt-2 text-sm text-gray-500">- Native American Proverb</cite>
                            </blockquote>
                        </div>
                        <div class="md:w-1/2">
                            <h3 class="text-2xl font-semibold mb-4 text-green-700">Our Solution: Simple, Responsible Recycling</h3>
                            <p class="text-gray-700 mb-6">Our platform connects you with local recycling authorities, making it effortless to dispose of your e-waste safely. We provide a transparent system that not only helps the planet but also rewards you for your contribution.</p>
                            <ul class="space-y-4">
                                <li class="flex items-start"><span class="text-green-500 mr-3 mt-1" aria-hidden="true">&#10003;</span><span><strong>Easy Pickup:</strong> Schedule a collection from your doorstep in minutes.</span></li>
                                <li class="flex items-start"><span class="text-green-500 mr-3 mt-1" aria-hidden="true">&#10003;</span><span><strong>Trackable Process:</strong> Monitor your e-waste's journey from pickup to recycling.</span></li>
                                <li class="flex items-start"><span class="text-green-500 mr-3 mt-1" aria-hidden="true">&#10003;</span><span><strong>Get Rewarded:</strong> Earn points for every item you recycle and contribute to a circular economy.</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

             <section id="process" class="py-20 bg-gray-100"> <div class="container mx-auto px-6">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold">A Simple 3-Step Process</h2>
                        <p class="text-gray-600 mt-2">Recycling your electronics has never been easier.</p>
                    </div>
                    <div class="grid md:grid-cols-3 gap-8 text-center">
                        <div id="submit-step-btn" class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 cursor-pointer">
                            <div class="bg-green-100 text-green-600 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">1. Submit a Request</h3>
                            <p class="text-gray-600">Fill out a simple form with details about your e-waste.</p>
                        </div>
                        <a href="#track" class="block text-current no-underline">
                            <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 h-full">
                                <div class="bg-green-100 text-green-600 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 10h-4v4h4v-4Z"></path><path d="M20 10h-4v4h4v-4Z"></path><path d="M4 10h4v4H4v-4Z"></path></svg>
                                </div>
                                <h3 class="text-xl font-semibold mb-2">2. Track Your Collection</h3>
                                <p class="text-gray-600">Use your unique request ID to track the status of your pickup.</p>
                            </div>
                        </a>
                        <a href="#rewards" class="block text-current no-underline">
                            <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 h-full">
                                <div class="bg-green-100 text-green-600 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m15.5 13.5-3 3-1.5-1.5"></path><path d="M2 13.3V18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-4.7"></path><path d="M12 15H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 12.5V8.8c0-1-.8-1.8-1.8-1.8h-1.3L12 2 9.1 7H7.8C6.8 7 6 7.8 6 8.8V12"></path></svg>
                                </div>
                                <h3 class="text-xl font-semibold mb-2">3. Earn Rewards</h3>
                                <p class="text-gray-600">Earn points and redeem them for exciting vouchers.</p>
                            </div>
                        </a>
                    </div>
                </div>
            </section>
            <section id="rewards" class="py-20 bg-white">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold">Earn Rewards for Recycling</h2>
                        <p class="text-gray-600 mt-2 max-w-2xl mx-auto">Your responsible actions deserve to be rewarded. Earn points for every item you recycle and redeem them for exciting vouchers.</p>
                    </div>
                    <div class="max-w-4xl mx-auto bg-gray-50 rounded-xl shadow-lg p-8 flex flex-col md:flex-row items-center gap-8 border border-gray-200">
                        <div class="md:w-1/2">
                            <h3 class="text-2xl font-semibold mb-4 text-green-700">How It Works</h3>
                            <ol class="list-decimal list-inside space-y-3 text-gray-700">
                                <li><strong>Recycle More:</strong> Earn 10 points for every electronic item you recycle.</li>
                                <li><strong>Accumulate Points:</strong> Watch your points grow in your "My Rewards" section.</li>
                                <li><strong>Claim Vouchers:</strong> Redeem your points for exciting vouchers.</li>
                            </ol>
                            <button id="view-rewards-btn" class="mt-6 bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors duration-300 shadow-md">
                                View Available Vouchers
                            </button>
                        </div>
                        <div class="md:w-1/2">
                            <img src="https://images.unsplash.com/photo-1620327429304-a5708873cef5?q=80&w=2070&auto=format&fit=crop" class="rounded-lg shadow-md" alt="A collection of gift cards and vouchers">
                        </div>
                    </div>
                </div>
            </section>
             <section id="track" class="py-20 bg-gray-100"> <div class="container mx-auto px-6 text-center">
                    <h2 class="text-3xl font-bold mb-4">Track Your E-Waste Pickup</h2>
                    <p class="text-gray-600 mb-8 max-w-xl mx-auto">Enter the request ID to see the current status of your collection.</p>
                    <div class="max-w-md mx-auto flex items-center border-2 border-gray-200 rounded-lg p-2 shadow-sm focus-within:border-green-500 focus-within:ring-1 focus-within:ring-green-500 bg-white">
                        <label for="track-id-input" class="sr-only">Request ID</label> <input type="text" id="track-id-input" placeholder="Enter your Request ID" class="w-full bg-transparent border-none focus:ring-0 text-lg px-3">
                        <button id="track-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-green-700 transition-colors duration-300">
                            Track
                        </button>
                    </div>
                    <div id="tracking-result" class="mt-6 text-lg" aria-live="polite"></div> </div>
            </section>

            <section id="leaderboard" class="py-20 bg-white"> <div class="container mx-auto px-6">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold text-gray-800">Top Recyclers</h2>
                        <p class="text-gray-600 mt-2 max-w-2xl mx-auto">Celebrating our most dedicated contributors to a greener planet!</p>
                    </div>
                    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 border border-gray-200">
                         <div id="leaderboard-loading" class="text-center p-4">
                             <p class="text-gray-500">Loading leaderboard...</p>
                         </div>
                         <ol id="leaderboard-list" class="hidden list-decimal list-inside space-y-4">
                             </ol>
                         <p id="leaderboard-empty" class="hidden text-center text-gray-500 mt-4">No recycling data yet to display a leaderboard.</p>
                    </div>
                </div>
            </section>
            </main>

        <footer class="bg-gray-800 text-white py-10">
            <div class="container mx-auto px-6 text-center">
                <p>&copy; 2025 Ekobin. All Rights Reserved.</p>
                <p class="text-gray-400 mt-2">Making the world cleaner, one device at a time.</p>
            </div>
        </footer>
    </div>

    <div id="request-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-30 p-4" role="dialog" aria-modal="true" aria-labelledby="request-modal-title">
        <div id="modal-content" class="bg-white w-full max-w-lg rounded-lg shadow-2xl p-8 relative transform transition-transform duration-300 scale-95">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" aria-label="Close modal">&times;</button>
            <h2 id="request-modal-title" class="text-2xl font-bold mb-6 text-center">Schedule a Pickup</h2>
            <form id="pickup-form">
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="name" name="name" required autocomplete="name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-4">
                    <label for="address" class="block text-sm font-medium text-gray-700">Full Address</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="address" name="address" required autocomplete="street-address" class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <button type="button" id="get-location-btn" class="inline-flex items-center px-3 py-2 border border-l-0 border-gray-300 bg-gray-50 text-gray-500 rounded-r-md hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500" title="Use my current location">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><line x1="21" y1="12" x2="23" y2="12"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line></svg>
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="phone" name="phone" required autocomplete="tel" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="waste-type" class="block text-sm font-medium text-gray-700">Type of E-Waste</label>
                        <select id="waste-type" name="waste-type" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            <option>Mobile Phones</option>
                            <option>Laptops & Computers</option>
                            <option>Televisions</option>
                            <option>Home Appliances</option>
                            <option>Wires</option>
                            <option>Batteries</option>
                            <option>Chargers</option>
                            <option>Other Electronics</option>
                        </select>
                    </div>
                     <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Approx. Quantity</label>
                        <input type="number" id="quantity" name="quantity" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>
                <button type="submit" id="submit-request-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300 flex items-center justify-center">
                    Submit Request
                </button>
            </form>
        </div>
    </div>
    <div id="history-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-30 p-4" role="dialog" aria-modal="true" aria-labelledby="history-modal-title">
        <div id="history-modal-content" class="bg-white w-full max-w-2xl rounded-lg shadow-2xl p-8 relative transform transition-transform duration-300 scale-95 max-h-[80vh] flex flex-col">
            <button id="close-history-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" aria-label="Close history modal">&times;</button>
            <h2 id="history-modal-title" class="text-2xl font-bold mb-6 text-center text-gray-800">Your Recycling History</h2>
            <div id="history-list" class="overflow-y-auto space-y-4 pr-2"></div>
        </div>
    </div>
    <div id="rewards-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-30 p-4" role="dialog" aria-modal="true" aria-labelledby="rewards-modal-title">
        <div id="rewards-modal-content" class="bg-white w-full max-w-3xl rounded-lg shadow-2xl p-8 relative transform transition-transform duration-300 scale-95 max-h-[80vh] flex flex-col">
            <button id="close-rewards-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" aria-label="Close rewards modal">&times;</button>
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 id="rewards-modal-title" class="text-2xl font-bold text-gray-800">My Rewards</h2>
                <div class="bg-green-100 text-green-800 font-bold text-lg px-4 py-2 rounded-lg">
                    Your Points: <span id="user-points">0</span>
                </div>
            </div>
            <div id="vouchers-list" class="overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4 pr-2"></div>
        </div>
    </div>
    <div id="claimed-vouchers-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-30 p-4" role="dialog" aria-modal="true" aria-labelledby="claimed-vouchers-modal-title">
        <div id="claimed-vouchers-modal-content" class="bg-white w-full max-w-3xl rounded-lg shadow-2xl p-8 relative transform transition-transform duration-300 scale-95 max-h-[80vh] flex flex-col">
            <button id="close-claimed-vouchers-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" aria-label="Close claimed vouchers modal">&times;</button>
            <h2 id="claimed-vouchers-modal-title" class="text-2xl font-bold mb-6 text-center text-gray-800">Your Claimed Vouchers</h2>
            <div id="claimed-vouchers-list" class="overflow-y-auto space-y-4 pr-2"></div>
        </div>
    </div>

    <div id="message-box" class="modal hidden fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-xl z-40" role="alert">
        <p id="message-text"></p>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, doc, getDoc, setDoc, enableNetwork, disableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
             apiKey: "AIzaSyBPNQHn7YAmTseXfORzQRWarDVI243b5TY", // Replace with your actual API key if needed
             authDomain: "ewaste-solution-3c406.firebaseapp.com",
             projectId: "ewaste-solution-3c406",
             storageBucket: "ewaste-solution-3c406.appspot.com",
             messagingSenderId: "336892357329",
             appId: "1:336892357329:web:0fd4fd574c81f28ddbf3f0",
             measurementId: "G-NN0CB2ZMDT"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-e-waste-app';

        // --- ADMIN EMAIL CONFIG ---
        const ADMIN_EMAIL = "saminderreddy8055@gmail.com";

        // --- Firebase Initialization ---
        let app, auth, db, userId;
        let isAuthReady = false;
        let initPromise;

        // --- UI Elements ---
        const initialLoading = document.getElementById('initial-loading');
        const getStartedOverlay = document.getElementById('get-started-overlay');
        const getStartedBtn = document.getElementById('get-started-btn');
        const authOverlay = document.getElementById('auth-overlay');
        const mainContent = document.getElementById('main-content');
        const loginFormContainer = document.getElementById('login-form-container');
        const signupFormContainer = document.getElementById('signup-form-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const toggleAuthMode = document.getElementById('toggle-auth-mode');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email-display'); // Dropdown section
        const userEmailText = document.getElementById('user-email-text'); // Text for email
        const adminLink = document.getElementById('admin-link');
        const requestModal = document.getElementById('request-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const openModalBtns = [document.getElementById('recycle-now-btn-hero'), document.getElementById('recycle-now-btn-nav')];
        const pickupForm = document.getElementById('pickup-form');
        const trackBtn = document.getElementById('track-btn');
        const trackInput = document.getElementById('track-id-input');
        const trackingResult = document.getElementById('tracking-result');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const historyModal = document.getElementById('history-modal');
        const historyModalContent = document.getElementById('history-modal-content');
        const closeHistoryModalBtn = document.getElementById('close-history-modal-btn');
        const myActivityBtn = document.getElementById('my-activity-btn');
        const historyList = document.getElementById('history-list');
        const rewardsModal = document.getElementById('rewards-modal');
        const rewardsModalContent = document.getElementById('rewards-modal-content');
        const closeRewardsModalBtn = document.getElementById('close-rewards-modal-btn');
        const myRewardsBtn = document.getElementById('my-rewards-btn');
        const viewRewardsBtn = document.getElementById('view-rewards-btn');
        const userPointsSpan = document.getElementById('user-points');
        const vouchersList = document.getElementById('vouchers-list');
        const submitStepBtn = document.getElementById('submit-step-btn');
        const claimedVouchersModal = document.getElementById('claimed-vouchers-modal');
        const claimedVouchersModalContent = document.getElementById('claimed-vouchers-modal-content');
        const closeClaimedVouchersModalBtn = document.getElementById('close-claimed-vouchers-modal-btn');
        const claimedVouchersBtn = document.getElementById('claimed-vouchers-btn');
        const claimedVouchersList = document.getElementById('claimed-vouchers-list');
        const leaderboardLoading = document.getElementById('leaderboard-loading');
        const leaderboardList = document.getElementById('leaderboard-list');
        const leaderboardEmpty = document.getElementById('leaderboard-empty');
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const getLocationBtn = document.getElementById('get-location-btn');
        const addressInput = document.getElementById('address');


        // Initialize Firebase
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase Initialized");
                await enableNetwork(db);
                console.log("Firestore network connection explicitly enabled.");
                return true;
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                if(initialLoading) {
                    initialLoading.innerHTML = `<p class="text-red-600 font-semibold text-center px-4">Error connecting to the Ekobin service.<br>Please check the console for details and refresh the page.</p>`;
                }
                return false;
            }
        }

        // Loading State for Auth Buttons
        const setAuthLoading = (isLoading) => {
            const loadingIcon = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...`;
            const googleIcon = `<svg class="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"></path></svg> Sign in with Google`;

            if (isLoading) {
                if(loginBtn) { loginBtn.disabled = true; loginBtn.innerHTML = loadingIcon; }
                if(signupBtn) { signupBtn.disabled = true; signupBtn.innerHTML = loadingIcon; }
                if(googleSigninBtn) { googleSigninBtn.disabled = true; googleSigninBtn.innerHTML = loadingIcon; }
            } else {
                if(loginBtn) { loginBtn.disabled = false; loginBtn.innerHTML = 'Log In'; }
                if(signupBtn) { signupBtn.disabled = false; signupBtn.innerHTML = 'Sign Up'; }
                if(googleSigninBtn) { googleSigninBtn.disabled = false; googleSigninBtn.innerHTML = googleIcon; }
            }
        };

        // Central Auth State Management
        async function setupAuthListener() {
            const initialized = await initPromise;
            if (!initialized || !auth) { console.error("Cannot set up auth listener: Firebase not initialized properly."); return; }

            onAuthStateChanged(auth, async user => {
                console.log("Auth state changed. User:", user);
                isAuthReady = true;
                initialLoading?.classList.add('hidden');

                if (user) {
                    userId = user.uid;
                    getStartedOverlay?.classList.add('hidden');
                    authOverlay?.classList.add('hidden');
                    mainContent?.classList.remove('hidden');

                    if(userEmailDisplay && userEmailText) {
                        userEmailText.textContent = user.email || 'Logged In';
                        userEmailDisplay.setAttribute('title', user.email || 'Logged In');
                        userEmailDisplay.classList.remove('hidden');
                    }
                    if (adminLink) {
                        user.email === ADMIN_EMAIL ? adminLink.classList.remove('hidden') : adminLink.classList.add('hidden');
                    }

                    console.log("User logged in:", userId);
                    if (db) { enableNetwork(db).catch(err => console.warn("Could not re-enable network:", err)); }
                    await fetchAndDisplayLeaderboard();
                } else {
                    userId = null;
                    mainContent?.classList.add('hidden');

                    if (userEmailDisplay) { userEmailDisplay.classList.add('hidden'); }
                    if (adminLink) { adminLink.classList.add('hidden'); }

                    userMenuDropdown?.classList.add('hidden');

                    authOverlay?.classList.add('hidden');
                    getStartedOverlay?.classList.remove('hidden');

                    console.log("User logged out. Showing Get Started page.");

                    if(leaderboardList) { leaderboardList.innerHTML = ''; leaderboardList.classList.add('hidden'); }
                    if(leaderboardLoading) leaderboardLoading.classList.remove('hidden');
                    if(leaderboardEmpty) leaderboardEmpty.classList.add('hidden');
                }
                setAuthLoading(false);
            });
        }

        // Auth Form Logic
        toggleAuthMode?.addEventListener('click', (e) => {
            e.preventDefault();
            loginFormContainer?.classList.toggle('hidden');
            signupFormContainer?.classList.toggle('hidden');
            if (toggleAuthMode) { toggleAuthMode.textContent = signupFormContainer?.classList.contains('hidden') ? 'Need an account? Sign Up' : 'Already have an account? Log In'; }
        });
        signupForm?.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isAuthReady || !auth) { showMessage("Please wait, connecting...", true); return; }
            setAuthLoading(true);
            const email = signupForm['signup-email']?.value;
            const password = signupForm['signup-password']?.value;
            if (!email || !password) { console.error("Signup form elements not found"); setAuthLoading(false); return; }
            createUserWithEmailAndPassword(auth, email, password).catch(error => { showMessage(error.message, true); setAuthLoading(false); });
        });
        loginForm?.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isAuthReady || !auth) { showMessage("Please wait, connecting...", true); return; }
            setAuthLoading(true);
            const email = loginForm['login-email']?.value;
            const password = loginForm['login-password']?.value;
            if (!email || !password) { console.error("Login form elements not found"); setAuthLoading(false); return; }
            signInWithEmailAndPassword(auth, email, password).catch(error => { showMessage(error.message, true); setAuthLoading(false); });
        });
        googleSigninBtn?.addEventListener('click', () => {
             if (!isAuthReady || !auth) { showMessage("Please wait, connecting...", true); return; }
            setAuthLoading(true);
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => { showMessage(error.message, true); setAuthLoading(false); });
        });
        logoutBtn?.addEventListener('click', () => {
            if (auth) { signOut(auth).catch(error => showMessage("Logout failed: " + error.message, true)); }
        });

        // Get Started Button Logic
        getStartedBtn?.addEventListener('click', () => {
            console.log("Get Started button clicked.");
            getStartedOverlay?.classList.add('hidden');
            authOverlay?.classList.remove('hidden');
        });

        // Modal Logic
        const openModal = (modal, content) => { if (modal && content) { modal.classList.remove('hidden'); setTimeout(() => content.classList.remove('scale-95'), 10); } };
        const closeModal = (modal, content) => { if (modal && content) { content.classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 300); } };
        openModalBtns.forEach(btn => btn?.addEventListener('click', () => { if (checkFirestoreReady()) openModal(requestModal, modalContent); }));
        closeModalBtn?.addEventListener('click', () => closeModal(requestModal, modalContent));
        requestModal?.addEventListener('click', (e) => { if (e.target === requestModal) closeModal(requestModal, modalContent); });
        myActivityBtn?.addEventListener('click', (e) => { e.preventDefault(); fetchAndShowHistory(); });
        closeHistoryModalBtn?.addEventListener('click', () => closeModal(historyModal, historyModalContent));
        historyModal?.addEventListener('click', (e) => { if (e.target === historyModal) closeModal(historyModal, historyModalContent); });
        myRewardsBtn?.addEventListener('click', (e) => { e.preventDefault(); fetchAndShowRewards(); });
        viewRewardsBtn?.addEventListener('click', (e) => { e.preventDefault(); fetchAndShowRewards(); });
        closeRewardsModalBtn?.addEventListener('click', () => closeModal(rewardsModal, rewardsModalContent));
        rewardsModal?.addEventListener('click', (e) => { if (e.target === rewardsModal) closeModal(rewardsModal, rewardsModalContent); });
        claimedVouchersBtn?.addEventListener('click', (e) => { e.preventDefault(); fetchAndShowClaimedVouchers(); });
        closeClaimedVouchersModalBtn?.addEventListener('click', () => closeModal(claimedVouchersModal, claimedVouchersModalContent));
        claimedVouchersModal?.addEventListener('click', (e) => { if (e.target === claimedVouchersModal) closeModal(claimedVouchersModal, claimedVouchersModalContent); });
        submitStepBtn?.addEventListener('click', () => { if (checkFirestoreReady()) openModal(requestModal, modalContent); });

        // Custom Message Box
        function showMessage(message, isError = false) {
             if (!messageBox || !messageText) return;
             messageBox.classList.remove('bg-red-600', 'bg-green-600', 'hidden', 'opacity-0');
             messageBox.classList.add(isError ? 'bg-red-600' : 'bg-green-600', 'opacity-100');
             messageText.textContent = message;
             setTimeout(() => {
                 messageBox.classList.remove('opacity-100');
                 messageBox.classList.add('opacity-0');
                 setTimeout(() => messageBox.classList.add('hidden'), 300);
             }, 5000);
        }

        // Helper: Check Auth and Firestore Readiness
        function checkFirestoreReady() {
            if (!initPromise || !db) { console.error("Firestore check failed: Firebase not fully initialized."); showMessage("Service not ready. Please refresh.", true); return false; }
            if (!isAuthReady) { console.warn("Firestore check failed: Auth state not determined yet."); showMessage("Connecting to session, please wait...", true); return false; }
            if (!userId) { console.warn("Firestore check failed: User not logged in."); showMessage("You need to be logged in to perform this action.", true); return false; }
            console.log("Firestore check passed. Auth Ready: ", isAuthReady, " UserID: ", userId);
            return true;
        }

        // Points Logic
        async function updateUserPoints(userIdParam, pointsToAdd) {
             if (!userIdParam || !db) return undefined;
            const userRef = doc(db, `/artifacts/${appId}/users/${userIdParam}/profile`, 'data');
            try {
                const userDoc = await getDoc(userRef);
                const currentPointsVal = userDoc.exists() ? (userDoc.data()?.points || 0) : 0;
                const newPoints = Math.max(0, currentPointsVal + pointsToAdd);
                await setDoc(userRef, { points: newPoints }, { merge: true });
                console.log(`Points updated for ${userIdParam} to ${newPoints}`);
                return newPoints;
            } catch (error) {
                console.error("Error updating points for user:", userIdParam, error);
                const message = error.code === 'unavailable' ? "Network error: Could not update points." :
                                error.code === 'permission-denied' ? "Error: Permission denied to update points." :
                                "Could not update your points: " + error.message;
                showMessage(message, true);
                return undefined;
            }
        }

        // Form Submission Logic
        pickupForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!checkFirestoreReady()) return;
            const submitBtn = document.getElementById('submit-request-btn');
            if (!submitBtn || !pickupForm) return;

            const name = pickupForm.name?.value;
            const address = pickupForm.address?.value;
            const phone = pickupForm.phone?.value;
            const wasteType = pickupForm['waste-type']?.value;
            const quantity = Number(pickupForm.quantity?.value);

            // INDIAN PHONE NUMBER VALIDATION
            const indianPhoneRegex = /^(\+91[\-\s]?)?[6-9]\d{9}$/;
            if (!phone || !indianPhoneRegex.test(phone)) {
                showMessage("Please enter a valid 10-digit Indian mobile number (optionally starting with +91).", true);
                return; // Stop submission
            }

            // General validation for other fields
            if (!name || !address || !wasteType || !quantity || quantity <= 0) {
                 console.error("Form elements missing or invalid (excluding phone check).");
                 showMessage("Please fill all fields correctly.", true);
                 return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...`;
            const requestId = `EW${Date.now()}`;

            // --- THIS BLOCK IS MODIFIED ---
            try {
                const docRef = await addDoc(collection(db, `/artifacts/${appId}/public/data/requests`), {
                    name, address, phone, wasteType, quantity, status: 'Submitted',
                    createdAt: serverTimestamp(), userId, requestId,
                    pointsAwarded: false // 1. ADDED THIS FIELD
                });
                console.log("Request document added to public collection with ID: ", docRef.id);
                
                // 2. REMOVED POINT CALCULATION
                // 3. REMOVED updateUserPoints CALL

                // 4. CHANGED SUCCESS MESSAGE
                showMessage(`Request submitted! Your ID is ${requestId}. Points will be awarded after collection.`);
                pickupForm.reset();
                closeModal(requestModal, modalContent);
            } catch (error) {
                console.error("Error adding request document: ", error);
                const message = error.code === 'unavailable' ? "Network error: Could not submit request." :
                                error.code === 'permission-denied' ? "Error: Permission denied to submit request." :
                                "Failed to submit request: " + error.message;
                showMessage(message, true);
            } finally {
                submitBtn.disabled = false; submitBtn.textContent = 'Submit Request';
            }
            // --- END OF MODIFIED BLOCK ---
        });

        // Tracking Logic
        trackBtn?.addEventListener('click', async () => {
             if (!db || !trackInput || !trackingResult) return;
            const requestId = trackInput.value.trim();
            if (!requestId) { showMessage("Please enter a Request ID.", true); return; }
            trackingResult.innerHTML = `<span class="text-gray-500">Searching...</span>`;
            try {
                const q = query(collection(db, `/artifacts/${appId}/public/data/requests`), where("requestId", "==", requestId));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    trackingResult.innerHTML = `<span class="text-red-500 font-semibold">No request found with ID: ${requestId}.</span>`;
                } else {
                    querySnapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        const status = data.status || 'Unknown';
                        let statusColor = 'text-gray-600';
                        if (status.toLowerCase() === 'submitted') statusColor = 'text-blue-600';
                        else if (status.toLowerCase() === 'collected') statusColor = 'text-green-600';
                        else if (status.toLowerCase() === 'approved') statusColor = 'text-yellow-600';
                        else if (status.toLowerCase() === 'rejected') statusColor = 'text-red-600';
                        trackingResult.innerHTML = `Status for Request <strong class="text-gray-900">${requestId}</strong> is: <strong class="${statusColor}">${status}</strong>`;
                    });
                }
            } catch (error) {
                console.error("Error fetching tracking data: ", error);
                const message = error.code === 'unavailable' ? "Network error. Please try again." :
                                error.code === 'permission-denied' ? "Permission error." :
                                "Error fetching status. Please try again.";
                trackingResult.innerHTML = `<span class="text-red-500 font-semibold">${message}</span>`;
                showMessage("Error fetching status: " + error.message, true);
            }
        });

        // Fetch and Display History
        const fetchAndShowHistory = async () => {
             if (!checkFirestoreReady() || !historyList) return;
             openModal(historyModal, historyModalContent);
            historyList.innerHTML = `<div class="text-center p-8"><span class="text-gray-500">Fetching history...</span></div>`;
            try {
                const q = query(collection(db, `/artifacts/${appId}/public/data/requests`), where("userId", "==", userId));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    historyList.innerHTML = `<div class="text-center p-8"><h3 class="mt-2 text-lg font-medium text-gray-900">No history found</h3><p class="mt-1 text-sm text-gray-500">You haven't recycled any e-waste yet.</p></div>`;
                } else {
                    historyList.innerHTML = '';
                    const docs = querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                    docs.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    docs.forEach(data => {
                        const status = data.status || 'N/A';
                        let statusColor = 'bg-gray-100 text-gray-800';
                        if (status.toLowerCase() === 'submitted') statusColor = 'bg-blue-100 text-blue-800';
                        else if (status.toLowerCase() === 'collected') statusColor = 'bg-green-100 text-green-800';
                        else if (status.toLowerCase() === 'approved') statusColor = 'bg-yellow-100 text-yellow-800';
                        else if (status.toLowerCase() === 'rejected') statusColor = 'bg-red-100 text-red-800';
                        const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A';
                        const wasteTypeImages = {
                            'Mobile Phones': 'https://images.unsplash.com/photo-1580910051074-3eb694886505?q=80&w=200&auto=format&fit=crop',
                            'Laptops & Computers': 'https://images.unsplash.com/photo-1525547719571-a2d4ac8945e2?q=80&w=200&auto=format&fit=crop',
                            'Televisions': 'https://images.unsplash.com/photo-1593359677879-a4bb92f829d1?q=80&w=200&auto=format&fit=crop',
                            'Home Appliances': 'https://images.unsplash.com/photo-1571175443880-49e1d25b2dcb?q=80&w=200&auto=format&fit=crop',
                            'Wires': 'https://placehold.co/100x100/e2e8f0/4a5568?text=Wires',
                            'Batteries': 'https://placehold.co/100x100/e2e8f0/4a5568?text=Battery',
                            'Chargers': 'https://placehold.co/100x100/e2e8f0/4a5568?text=Charger',
                            'Other Electronics': 'https://placehold.co/100x100/e2e8f0/4a5568?text=E-Waste'
                        };
                        const imageUrl = wasteTypeImages[data.wasteType] || wasteTypeImages['Other Electronics'];
                        const itemHtml = `<div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm flex items-center space-x-4"><img src="${imageUrl}" alt="${data.wasteType} icon" class="w-20 h-20 object-cover rounded-md flex-shrink-0 bg-gray-200" onerror="this.onerror=null; this.src='https://placehold.co/100x100/e2e8f0/4a5568?text=Image'"><div class="flex-grow flex justify-between items-start"><div><h4 class="font-bold text-lg text-gray-800">${data.wasteType}</h4><p class="text-sm text-gray-600">Quantity: ${data.quantity}</p><p class="text-xs text-gray-400 mt-1">ID: ${data.requestId}</p></div><div class="text-right flex-shrink-0 ml-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">${status}</span><p class="text-sm text-gray-500 mt-2">${date}</p></div></div></div>`;
                        historyList.innerHTML += itemHtml;
                    });
                }
            } catch (error) {
                console.error("Error fetching history: ", error);
                const message = error.code === 'unavailable' ? "Network error. Please try again." :
                                error.code === 'permission-denied' ? "Permission error." :
                                "Could not load history.";
                if(historyList) historyList.innerHTML = `<div class="text-center p-8"><span class="text-red-500 font-semibold">${message}</span></div>`;
                // --- THIS LINE IS FIXED ---
                showMessage("Could not load history: " + error.message, true);
            }
        };

        // Fetch and Display Rewards
        const VOUCHERS = [
            { id: "amazon100", name: "Amazon Gift Card", value: "100", points: 100, imageUrl: "https://images.unsplash.com/photo-1553775282-20af807797d1?q=80&w=200&auto=format&fit=crop" },
            { id: "flipkart150", name: "Flipkart Voucher", value: "150", points: 150, imageUrl: "https://placehold.co/200x128/1e40af/ffffff?text=Flipkart" },
            { id: "zomato", name: "Zomato Coupon", value: "200 Off", points: 200, imageUrl: "https://placehold.co/200x128/ef4444/ffffff?text=Zomato" },
            { id: "swiggy", name: "Swiggy Discount", value: "30% Off", points: 250, imageUrl: "https://placehold.co/200x128/f97316/ffffff?text=Swiggy" },
            { id: "coffee", name: "Coffee Coupon", value: "Free Coffee", points: 150, imageUrl: "https://images.unsplash.com/photo-1511920183353-3c613c75a48e?q=80&w=200&auto=format&fit=crop" },
            { id: "movie", name: "Movie Ticket", value: "50% Off", points: 250, imageUrl: "https://images.unsplash.com/photo-1594909122845-11baa439b7bf?q=80&w=200&auto=format&fit=crop" },
            { id: "plant", name: "Eco-Friendly Plant", value: "Free Sapling", points: 500, imageUrl: "https://images.unsplash.com/photo-1459156212016-c812468e2115?q=80&w=200&auto=format&fit=crop" },
            { id: "myntra", name: "Myntra Voucher", value: "300", points: 300, imageUrl: "https://placehold.co/200x128/f43f5e/ffffff?text=Myntra" },
            { id: "ekobin50off", name: "Ekobin Voucher", value: "50% Off", points: 300, imageUrl: "https://placehold.co/200x128/16a34a/ffffff?text=Ekobin" }
        ];
        let currentPoints = 0;
        const fetchAndShowRewards = async () => {
             if (!checkFirestoreReady() || !vouchersList || !userPointsSpan) return;
            openModal(rewardsModal, rewardsModalContent);
            vouchersList.innerHTML = `<div class="text-center p-8"><span class="text-gray-500">Loading rewards...</span></div>`;
            try {
                const userRef = doc(db, `/artifacts/${appId}/users/${userId}/profile`, 'data');
                const userDoc = await getDoc(userRef);
                currentPoints = userDoc.exists() ? (userDoc.data()?.points || 0) : 0;
                userPointsSpan.textContent = currentPoints;
                vouchersList.innerHTML = '';
                VOUCHERS.forEach(voucher => {
                    const canClaim = currentPoints >= voucher.points;
                    const btnClass = canClaim ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 cursor-not-allowed';
                    const btnDisabled = !canClaim;

                    const voucherHtml = `<div class="bg-gray-50 border border-gray-200 rounded-lg p-4 flex flex-col text-center"><img src="${voucher.imageUrl}" alt="${voucher.name} reward image" class="w-full h-32 object-cover rounded-md mb-4 bg-gray-200" onerror="this.onerror=null; this.src='https://placehold.co/200x128/e2e8f0/4a5568?text=Reward'"><h4 class="font-bold text-lg">${voucher.name}</h4><p class="text-gray-600 mb-2">${voucher.value}</p><p class="font-bold text-green-600 text-lg mb-3">${voucher.points} pts</p><button class="claim-btn mt-auto text-white font-semibold py-2 px-4 rounded-md transition-colors ${btnClass}" data-id="${voucher.id}" data-points="${voucher.points}" data-name="${voucher.name}" data-value="${voucher.value}" ${btnDisabled ? 'disabled' : ''}>Claim</button></div>`;

                    vouchersList.innerHTML += voucherHtml;
                });
                document.querySelectorAll('.claim-btn').forEach(button => button.addEventListener('click', handleClaimVoucher));
            } catch (error) {
                 console.error("Error fetching rewards points: ", error);
                 const message = error.code === 'unavailable' ? "Network error." : error.code === 'permission-denied' ? "Permission error." : "Could not load rewards.";
                 if(vouchersList) vouchersList.innerHTML = `<div class="text-center p-8"><span class="text-red-500 font-semibold">${message}</span></div>`;
                 showMessage("Could not load rewards: " + error.message, true);
            }
        };
        async function handleClaimVoucher(event) {
             if (!checkFirestoreReady() || !(event.target instanceof HTMLButtonElement)) return;
              const button = event.target;
             const pointsCost = Number(button.dataset.points);
             const voucherName = button.dataset.name;
             const voucherValue = button.dataset.value;
             const voucherId = button.dataset.id;
             let latestPoints = 0;
             try {
                 const userRef = doc(db, `/artifacts/${appId}/users/${userId}/profile`, 'data');
                 const userDoc = await getDoc(userRef);
                 latestPoints = userDoc.exists() ? (userDoc.data()?.points || 0) : 0;
             } catch(error) { /* Handle error getting points */ console.error("Error verifying points:", error); showMessage("Could not verify points.", true); return; }
             if (latestPoints < pointsCost) { showMessage("Not enough points.", true); return; }
             button.disabled = true; button.textContent = 'Claiming...';
             const newPoints = await updateUserPoints(userId, -pointsCost);
             if (typeof newPoints !== 'undefined') {
                 const voucherCode = `VCHR-${Date.now()}`;
                 try {
                     await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/claimedVouchers`), {
                         name: voucherName, value: voucherValue, code: voucherCode, voucherId, claimedAt: serverTimestamp()
                     });
                     showMessage(`Voucher claimed! Code: ${voucherCode}`);
                     await fetchAndShowRewards(); // Refresh
                 } catch(claimError) {
                     console.error("Error saving claimed voucher:", claimError);
                     showMessage("Claim failed after points deducted. Refunding.", true);
                     await updateUserPoints(userId, pointsCost); // Refund
                     await fetchAndShowRewards(); // Refresh again
                 }
             } else {
                 showMessage("Failed to update points. Claim aborted.", true);
                 button.disabled = false; button.textContent = 'Claim';
             }
        }

        // Fetch and Display Claimed Vouchers
        const fetchAndShowClaimedVouchers = async () => {
             if (!checkFirestoreReady() || !claimedVouchersList) return;
            openModal(claimedVouchersModal, claimedVouchersModalContent);
            claimedVouchersList.innerHTML = `<div class="text-center p-8"><span class="text-gray-500">Fetching claimed vouchers...</span></div>`;
            try {
                const q = query(collection(db, `/artifacts/${appId}/users/${userId}/claimedVouchers`));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    claimedVouchersList.innerHTML = `<div class="text-center p-8"><h3 class="mt-2 text-lg font-medium text-gray-900">No vouchers claimed</h3><p class="mt-1 text-sm text-gray-500">You haven't claimed any rewards yet.</p></div>`;
                } else {
                    claimedVouchersList.innerHTML = '';
                    const docs = querySnapshot.docs.map(docSnap => docSnap.data());
                    docs.sort((a, b) => (b.claimedAt?.toMillis() || 0) - (a.claimedAt?.toMillis() || 0));
                    docs.forEach(data => {
                        const date = data.claimedAt ? data.claimedAt.toDate().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A';
                        const itemHtml = `<div class="bg-gray-50 p-4 rounded-lg border border-green-200 shadow-sm"><div class="flex justify-between items-start"><div><h4 class="font-bold text-lg text-green-800">${data.name}</h4><p class="text-sm text-gray-600">Value: ${data.value}</p><p class="text-md font-mono bg-gray-200 text-gray-800 inline-block px-2 py-1 rounded mt-2">${data.code}</p></div><div class="text-right flex-shrink-0 ml-4"><p class="text-sm text-gray-500 mt-1">Claimed on: ${date}</p></div></div></div>`;
                        claimedVouchersList.innerHTML += itemHtml;
                    });
                }
            } catch (error) {
                console.error("Error fetching claimed vouchers: ", error);
                const message = error.code === 'unavailable' ? "Network error." : error.code === 'permission-denied' ? "Permission error." : "Could not load vouchers.";
                if(claimedVouchersList) claimedVouchersList.innerHTML = `<div class="text-center p-8"><span class="text-red-500 font-semibold">${message}</span></div>`;
                showMessage("Could not load claimed vouchers: " + error.message, true);
            }
        };

        // Fetch and Display Leaderboard
        async function fetchAndDisplayLeaderboard() {
            if (!db || !leaderboardList || !leaderboardLoading || !leaderboardEmpty) { console.error("Leaderboard elements or DB missing."); return; }
            leaderboardList.classList.add('hidden'); leaderboardEmpty.classList.add('hidden'); leaderboardLoading.classList.remove('hidden');
            try {
                const q = query(
                    collection(db, `/artifacts/${appId}/public/data/requests`),
                    where("status", "in", ["Approved", "Collected"])
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { leaderboardLoading.classList.add('hidden'); leaderboardEmpty.classList.remove('hidden'); console.log("No Approved or Collected requests for leaderboard."); return; }

                const userTotals = {};
                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const reqUserId = data.userId; const reqQuantity = Number(data.quantity) || 0; const reqName = data.name || 'Anonymous';
                    if (!reqUserId || reqQuantity <= 0) return;
                    if (!userTotals[reqUserId]) { userTotals[reqUserId] = { name: reqName, totalQuantity: 0 }; }
                    userTotals[reqUserId].totalQuantity += reqQuantity;
                    userTotals[reqUserId].name = reqName;
                });

                const sortedUsers = Object.entries(userTotals)
                    .map(([id, data]) => ({ userId: id, ...data }))
                    .sort((a, b) => b.totalQuantity - a.totalQuantity);
                const top5 = sortedUsers.slice(0, 5);

                leaderboardList.innerHTML = '';
                if (top5.length === 0) { leaderboardLoading.classList.add('hidden'); leaderboardEmpty.classList.remove('hidden'); console.log("Processed requests, but no valid user totals."); return; }

                top5.forEach((user, index) => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center p-3 bg-gray-50 rounded-md border border-gray-200";
                    li.innerHTML = `<div class="flex items-center"><span class="text-lg font-bold text-green-600 mr-4">${index + 1}.</span><span class="font-semibold text-gray-700">${user.name}</span></div><span class="text-gray-600 font-medium">${user.totalQuantity} items</span>`;
                    leaderboardList.appendChild(li);
                });
                leaderboardLoading.classList.add('hidden'); leaderboardList.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching/processing leaderboard:", error);
                leaderboardLoading.classList.add('hidden');
                if(leaderboardList) leaderboardList.innerHTML = `<li class="text-center text-red-500">Could not load leaderboard data.</li>`;
                if(leaderboardList) leaderboardList.classList.remove('hidden');

                let message = "Error loading leaderboard: " + error.message;
                if (error.code === 'permission-denied') { message = "Permission denied for leaderboard."; }
                else if (error.code === 'unavailable') { message = "Network error loading leaderboard."; }
                else if (error.code === 'failed-precondition') {
                    message = "Leaderboard requires a database index. Check console.";
                    console.error("Firestore error likely indicates a missing index for the query on 'status' field using 'in'. Check the Firebase console error message for a link to create it automatically.");
                }
                showMessage(message, true);
            }
        }

        // GEOLOCATION LOGIC
        getLocationBtn?.addEventListener('click', () => {
            if (!addressInput) return;

            if (!navigator.geolocation) {
                showMessage("Geolocation is not supported by your browser.", true);
                return;
            }

            getLocationBtn.disabled = true;
            showMessage("Getting location...", false); // Show temporary message

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    console.log(`Location found: Lat: ${lat}, Lon: ${lon}`);

                    // Use OpenStreetMap Nominatim for reverse geocoding
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;

                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();

                        if (data && data.display_name) {
                            addressInput.value = data.display_name; // Set address input value
                            showMessage("Location added to address field.", false);
                        } else {
                            throw new Error("Address not found in response.");
                        }
                    } catch (fetchError) {
                        console.error("Error fetching address:", fetchError);
                        showMessage("Could not fetch address from coordinates.", true);
                        addressInput.value = `Lat: ${lat}, Lon: ${lon}`; // Fallback to coordinates
                    } finally {
                        getLocationBtn.disabled = false;
                    }
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    let errMsg = "Could not get location.";
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errMsg = "Location permission denied.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errMsg = "Location information is unavailable.";
                            break;
                        case error.TIMEOUT:
                            errMsg = "Location request timed out.";
                            break;
                        case error.UNKNOWN_ERROR:
                            errMsg = "An unknown error occurred while getting location.";
                            break;
                    }
                    showMessage(errMsg, true);
                    getLocationBtn.disabled = false;
                }
            );
        });

        // User Menu Toggle Logic
        userMenuBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            userMenuDropdown?.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (userMenuDropdown && userMenuBtn && !userMenuDropdown.contains(e.target) && !userMenuBtn.contains(e.target)) {
                userMenuDropdown.classList.add('hidden');
            }
        });

        // --- Initialize Firebase and Auth Listener ---
         initPromise = initializeFirebase();
         setupAuthListener();

    </script>

</body>
</html>