<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekobin Admin Panel</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load Playfair Display and Inter fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom class for the heading font */
        .font-playfair {
            font-family: 'Playfair Display', serif;
        }
        /* Minimalist input style */
        .form-input {
            appearance: none;
            position: relative;
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            color: #111827; /* gray-900 */
            border-radius: 0.375rem; /* rounded-md */
        }
        .form-input::placeholder {
            color: #6b7280; /* gray-500 */
        }
        .form-input:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 1px #000;
        }
    </style>
</head>
<body class="bg-white text-gray-900">

    <!-- 1. Loading View -->
    <div id="loading-view" class="flex items-center justify-center min-h-screen">
        <svg class="animate-spin h-10 w-10 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- 2. Auth View -->
    <div id="auth-view" class="hidden min-h-screen flex items-center justify-center bg-white py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 border border-gray-300 p-10 rounded-lg">
            <div>
                <svg class="mx-auto h-12 w-auto text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 18H7.5m3-6h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 12H7.5" />
                </svg>
                <h2 class="mt-6 text-center text-4xl font-bold text-gray-900 font-playfair">Admin Panel Sign In</h2>
            </div>

            <!-- Auth Error Message -->
            <div id="auth-error" class="hidden p-3 bg-red-50 border border-red-300 text-red-700 rounded-md text-sm"></div>

            <!-- Login Form -->
            <form id="login-form" class="mt-8 space-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="sr-only">Email address</label>
                        <input id="login-email" name="email" type="email" autocomplete="email" required class="form-input" placeholder="Email address">
                    </div>
                    <div>
                        <label for="login-password" class="sr-only">Password</label>
                        <input id="login-password" name="password" type="password" autocomplete="current-password" required class="form-input" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                        Sign in
                    </button>
                </div>
            </form>

        </div>
    </div>

    <!-- 3. App View -->
    <div id="app-view" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo / App Name -->
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="h-8 w-auto text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 18H7.5m3-6h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 12H7.5" />
                        </svg>
                        <span class="font-bold font-playfair text-2xl ml-2 text-gray-900">Admin Panel</span>
                    </div>
                    
                    <!-- User Info & Sign Out -->
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div id="user-email" class="text-sm font-medium text-gray-700 hidden sm:block"></div>
                        </div>
                        <button id="signout-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                            <span class="sr-only">Sign Out</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                            </svg>
                        </button>
                    </div>

                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="max-w-7xl mx-auto py-10 sm:px-6 lg:px-8">
            
            <!-- Dashboard Section (All Pickups) -->
            <section id="dashboard-section" class="app-section px-4 sm:px-0">
                <div class="flex justify-between items-center">
                    <h2 class="text-4xl font-bold font-playfair tracking-tight text-gray-900">All Pickups</h2>
                    <div class="flex items-center space-x-2">
                        <label for="status-filter" class="text-sm font-medium text-gray-700">Filter by status:</label>
                        <select id="status-filter" name="status-filter" class="form-input bg-white text-sm py-1.5 w-48">
                            <option>All</option>
                            <option>Pickup Requested</option>
                            <option>Out for Pickup</option>
                            <option>In Transit</option>
                            <option>Completed</option>
                            <option>Cancelled</option>
                        </select>
                    </div>
                </div>
                <div id="all-pickups-grid" class="mt-8 space-y-6">
                    <!-- All Pickups will be injected here -->
                    <p id="all-pickups-placeholder" class="text-gray-500 col-span-full py-10 text-center">No pickups found.</p>
                </div>
            </section>
            
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 right-5 p-4 rounded-md shadow-lg text-white transition-all duration-300 translate-x-full opacity-0 z-50">
        <span id="toast-message"></span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            onValue, 
            update,
            query,
            orderByChild,
            equalTo
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- GLOBAL VARS & CONFIG ---
        
        // User's provided Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyAkVvJezcXrSIk4mPBOXoZiIwNbM0ma_XE",
          authDomain: "ewaste-recycle.firebaseapp.com",
          databaseURL: "https://ewaste-recycle-default-rtdb.firebaseio.com",
          projectId: "ewaste-recycle",
          storageBucket: "ewaste-recycle.firebasestorage.app",
          messagingSenderId: "93158859081",
          appId: "1:93158859081:web:7f1790461b268dfec13a98",
          measurementId: "G-93N6RWE14J"
        };
        
        // App ID from the environment (for DB namespacing)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app); // Using Realtime Database

        let currentUserId = null;
        let currentUserEmail = null;
        let currentStatusFilter = "All";
        
        // Firebase DB Refs
        const getPublicPickupsRef = () => ref(db, `artifacts/${appId}/public/data/pickups`);
        const getUserListingRef = (userId, listKey) => ref(db, `artifacts/${appId}/users/${userId}/listings/${listKey}`);
        
        // Unsubscribe function for RTDB listener
        let unsubAllPickups = () => {};

        // DOM Elements
        const loadingView = document.getElementById('loading-view');
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        
        const loginForm = document.getElementById('login-form');
        const authError = document.getElementById('auth-error');
        
        const userEmailEl = document.getElementById('user-email');
        const signoutBtn = document.getElementById('signout-btn');
        
        const allPickupsGrid = document.getElementById('all-pickups-grid');
        const allPickupsPlaceholder = document.getElementById('all-pickups-placeholder');
        const statusFilter = document.getElementById('status-filter');

        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');

        // --- UTILITY FUNCTIONS ---

        function showView(viewId) {
            loadingView.classList.add('hidden');
            authView.classList.add('hidden');
            appView.classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toast.classList.remove('bg-green-500', 'bg-red-500', 'translate-x-full', 'opacity-0');
            
            if (isError) {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-green-500');
            }
            toast.classList.remove('translate-x-full', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
            }, 3000);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function getStatusColorClasses(status) {
            switch (status) {
                case "Pickup Requested":
                    return { border: "border-l-blue-500", text: "text-blue-700", bg: "bg-blue-50" };
                case "Out for Pickup":
                    return { border: "border-l-yellow-500", text: "text-yellow-700", bg: "bg-yellow-50" };
                case "In Transit":
                    return { border: "border-l-purple-500", text: "text-purple-700", bg: "bg-purple-50" };
                case "Completed":
                    return { border: "border-l-green-500", text: "text-green-700", bg: "bg-green-50" };
                case "Cancelled":
                    return { border: "border-l-red-500", text: "text-red-700", bg: "bg-red-50" };
                default:
                    return { border: "border-l-gray-500", text: "text-gray-700", bg: "bg-gray-50" };
            }
        }
        
        function getStatusOptions(currentStatus) {
            const statuses = ["Pickup Requested", "Out for Pickup", "In Transit", "Completed", "Cancelled"];
            return statuses.map(s => 
                `<option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s}</option>`
            ).join('');
        }

        // --- AUTHENTICATION ---

        onAuthStateChanged(auth, (user) => {
            // Clear all previous listeners to prevent leaks
            unsubAllPickups();
            
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                currentUserEmail = user.email;
                userEmailEl.textContent = currentUserEmail;
                
                // Set up all real-time data listeners
                setupListeners();
                
                showView('app-view');
            } else {
                // User is signed out
                currentUserId = null;
                currentUserEmail = null;
                
                // Reset UI
                allPickupsGrid.innerHTML = '';
                
                showView('auth-view');
            }
        });

        async function initialSignIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // No token, show login screen
                    console.log("No initial token. Waiting for user login.");
                    showView('auth-view');
                }
            } catch (error) {
                console.error("Initial auth failed:", error);
                // If all else fails, show login screen
                showView('auth-view');
            }
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.classList.add('hidden');
            } catch (error) {
                authError.textContent = error.message;
                authError.classList.remove('hidden');
            }
        });

        // Handle Sign Out
        signoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // --- FIREBASE RTDB LISTENERS ---
        
        function setupListeners() {
            unsubAllPickups(); // Unsubscribe from any previous listener
            
            let queryRef = getPublicPickupsRef();
            
            if (currentStatusFilter !== "All") {
                // Apply filter if "All" is not selected
                queryRef = query(getPublicPickupsRef(), orderByChild('status'), equalTo(currentStatusFilter));
            }
            
            // 1. Listen to all public pickups
            unsubAllPickups = onValue(queryRef, (snapshot) => {
                renderAllPickups(snapshot.val());
            });
        }
        
        // --- RENDER FUNCTIONS ---
        
        function renderAllPickups(data) {
            allPickupsGrid.innerHTML = ''; // Clear existing
            
            if (!data) {
                allPickupsGrid.appendChild(allPickupsPlaceholder);
                allPickupsPlaceholder.classList.remove('hidden');
                return;
            }
            
            allPickupsPlaceholder.classList.add('hidden');

            // Sort by createdAt, newest first
            const sortedEntries = Object.entries(data).sort(([, a], [, b]) => (b.createdAt || 0) - (a.createdAt || 0));

            sortedEntries.forEach(([key, item]) => {
                const card = document.createElement('div');
                const statusColors = getStatusColorClasses(item.status);
                
                card.className = `bg-white border border-gray-200 rounded-lg overflow-hidden border-l-4 ${statusColors.border}`;
                
                card.innerHTML = `
                    <div class="p-5">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-lg font-semibold text-gray-900">${item.brand} ${item.model}</p>
                                <p class="text-sm text-gray-600">${item.category}</p>
                            </div>
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusColors.text} ${statusColors.bg}">
                                ${item.status}
                            </span>
                        </div>
                        
                        <div class="border-t border-gray-200 mt-4 pt-4">
                            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-y-2 gap-x-4 text-sm">
                                <div>
                                    <dt class="font-medium text-gray-500">User Email</dt>
                                    <dd class="text-gray-900">${item.listedByEmail || 'N/A'}</dd>
                                </div>
                                <div>
                                    <dt class="font-medium text-gray-500">Address</dt>
                                    <dd class="text-gray-900">${item.address || 'N/A'}</dd>
                                </div>
                                <div>
                                    <dt class="font-medium text-gray-500">Requested On</dt>
                                    <dd class="text-gray-900">${formatDate(item.createdAt)}</dd>
                                </div>
                                <div>
                                    <dt class="font-medium text-gray-500">Tracking ID</dt>
                                    <dd class="text-gray-900 font-mono text-xs">${key}</dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div class="border-t border-gray-200 mt-4 pt-4 flex items-center space-x-3">
                            <label for="status-${key}" class="text-sm font-medium text-gray-700">Update Status:</label>
                            <select id="status-${key}" 
                                    data-key="${key}" 
                                    data-userid="${item.listedById}" 
                                    class="status-select-admin form-input bg-white text-sm py-1.5 w-48">
                                ${getStatusOptions(item.status)}
                            </select>
                        </div>
                    </div>
                `;
                allPickupsGrid.appendChild(card);
            });
        }
        
        // --- CORE APP ACTIONS ---
        
        /**
         * Handle status filter change
         */
        statusFilter.addEventListener('change', (e) => {
            currentStatusFilter = e.target.value;
            setupListeners(); // Re-run listeners with the new filter
        });

        /**
         * Handle status update from admin (event delegation)
         */
        allPickupsGrid.addEventListener('change', async (e) => {
            if (e.target.classList.contains('status-select-admin')) {
                const selectEl = e.target;
                const newStatus = selectEl.value;
                const itemKey = selectEl.dataset.key;
                const userId = selectEl.dataset.userid;
                
                if (!itemKey || !userId) {
                    showToast("Error: Missing user or item ID.", true);
                    return;
                }
                
                selectEl.disabled = true;
                
                try {
                    // Update status in both public and private user locations
                    const updates = {};
                    updates[`artifacts/${appId}/public/data/pickups/${itemKey}/status`] = newStatus;
                    updates[getUserListingRef(userId, itemKey).path.toString() + '/status'] = newStatus;
                    
                    await update(ref(db), updates);
                    
                    showToast("Status updated successfully.", false);
                    
                } catch (error) {
                    console.error("Error updating status:", error);
                    showToast("Error updating status: " + error.message, true);
                } finally {
                    selectEl.disabled = false;
                }
            }
        });
        
        // --- STARTUP ---
        initialSignIn();

    </script>
</body>
</html>

