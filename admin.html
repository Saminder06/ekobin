<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>Admin Dashboard - Ekobin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
         .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f; /* Blue color for spinner */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-select {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB;
            font-weight: 600;
            background-color: #fff;
            color: #111827;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
        }
        .status-Submitted { background-color: #DBEAFE; color: #1E40AF; }
        .status-Collected { background-color: #D1FAE5; color: #065F46; }
        .status-Approved { background-color: #FEF3C7; color: #92400E; }
        .status-Rejected { background-color: #FEE2E2; color: #991B1B; }

        /* User table styling */
        .user-table th, .user-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }
        .user-table th {
             background-color: #f9fafb;
             font-weight: 600;
             font-size: 0.75rem;
             text-transform: uppercase;
             letter-spacing: 0.05em;
             color: #4b5563;
        }
         .user-table td {
            font-size: 0.875rem;
            color: #1f2937;
         }
         .user-table .email-col {
            font-weight: 500;
         }
         .user-table .date-col {
             color: #6b7280;
         }
          .user-table .uid-col {
             color: #9ca3af;
             font-size: 0.75rem;
             font-family: monospace;
         }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-md w-full z-20 top-0">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-green-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 -mt-1" aria-hidden="true"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><path d="M12 14a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"></path><path d="M12 11v2"></path><path d="m10 13 4-4"></path></svg>
                Admin Dashboard
            </a>
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-sm text-blue-600 hover:underline">Back to User Site</a>

                <div class="relative">
                    <button id="admin-menu-btn" class="p-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6" aria-hidden="true">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                        <span class="sr-only">Open Admin Menu</span>
                    </button>

                    <div id="admin-menu-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg py-1 z-30 border border-gray-200">
                        <div class="px-4 py-3">
                            <p class="text-sm text-gray-500">Signed in as:</p>
                            <p id="user-email-display" class="text-sm text-gray-700 font-semibold truncate" title="Admin Email"></p>
                        </div>
                        <div class="border-t border-gray-100"></div>
                        <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 transition-colors duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
            </nav>
    </header>

    <main class="container mx-auto p-6 mt-20 space-y-10">
        <div>
            <h1 class="text-3xl font-bold mb-6">All Pickup Requests</h1>
            <div id="admin-message" class="text-center p-10" aria-live="polite">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Loading admin data...</p>
            </div>
            <div id="requests-list" class="hidden grid grid-cols-3 gap-6">
            </div>
        </div>

    </main>

    <div id="message-box" class="modal hidden fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-xl z-50" role="alert">
        <p id="message-text"></p>
    </div>

    <footer class="bg-gray-800 text-white py-10 mt-16">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2025 Ekobin. All Rights Reserved.</p>
        </div>
    </footer>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, doc, updateDoc, enableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
             apiKey: "AIzaSyBPNQHn7YAmTseXfORzQRWarDVI243b5TY",
             authDomain: "ewaste-solution-3c406.firebaseapp.com",
             projectId: "ewaste-solution-3c406",
             storageBucket: "ewaste-solution-3c406.appspot.com",
             messagingSenderId: "336892357329",
             appId: "1:336892357329:web:0fd4fd574c81f28ddbf3f0",
             measurementId: "G-NN0CB2ZMDT"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-e-waste-app';
        const ADMIN_EMAIL = "saminderreddy8055@gmail.com";

        // --- Firebase Initialization ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            await enableNetwork(db);
            console.log("Admin Page: Firebase Initialized");
        } catch (e) {
            console.error("Admin Page: Firebase init failed", e);
            const adminMsgEl = document.getElementById('admin-message');
            if (adminMsgEl) { adminMsgEl.innerHTML = `<p class="text-red-600 font-semibold">Error connecting to service.</p>`; }
        }

        // --- UI Elements ---
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        const adminMessage = document.getElementById('admin-message');
        const requestsList = document.getElementById('requests-list');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const adminMenuBtn = document.getElementById('admin-menu-btn');
        const adminMenuDropdown = document.getElementById('admin-menu-dropdown');

        // --- Custom Message Box ---
        function showMessage(message, isError = false) {
             if (!messageBox || !messageText) return;
             if (messageBox.timeoutId) clearTimeout(messageBox.timeoutId);
             messageBox.classList.remove('bg-red-600', 'bg-green-600', 'hidden', 'opacity-0');
             messageBox.classList.add(isError ? 'bg-red-600' : 'bg-green-600', 'opacity-100');
             messageText.textContent = message;
             messageBox.timeoutId = setTimeout(() => {
                 messageBox.classList.remove('opacity-100');
                 messageBox.classList.add('opacity-0');
                 setTimeout(() => { messageBox.classList.add('hidden'); messageBox.timeoutId = null; }, 300);
             }, 3000);
        }

        // --- Auth & Admin Check ---
        onAuthStateChanged(auth, user => {
             if (user) {
                 console.log("Admin Page: User logged in:", user.uid, user.email);
                 if(userEmailDisplay) { userEmailDisplay.textContent = user.email || 'Admin'; userEmailDisplay.setAttribute('title', user.email || 'Admin'); }
                 checkAdminStatusAndLoadData(user);
             } else {
                 console.log("Admin Page: No user logged in. Redirecting.");
                 window.location.href = 'index.html';
             }
        });

        async function checkAdminStatusAndLoadData(user) {
             if (!db || !adminMessage) return;
             try {
                 if (user.email === ADMIN_EMAIL) {
                     console.log("Admin Page: Access GRANTED for " + user.email);
                     adminMessage.innerHTML = `<p class="text-green-600 font-semibold">Admin access verified. Loading data...</p>`;
                     await loadAllRequests();
                     adminMessage.classList.add('hidden');
                 } else {
                     console.warn("Admin Page: Access DENIED. User " + user.email + " is not the designated admin.");
                     adminMessage.innerHTML = `<p class="text-red-600 font-semibold">ACCESS DENIED: You do not have admin permissions.</p>`;
                     setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                 }
             } catch (error) {
                 console.error("Admin Page: Error during admin check or data load:", error);
                 adminMessage.innerHTML = `<p class="text-red-600 font-semibold">Error loading admin data: ${error.message}</p>`;
                 adminMessage.classList.remove('hidden');
             }
        }

        // --- Load All Requests ---
        async function loadAllRequests() {
             if (!db || !requestsList || !adminMessage) { console.error("Admin Page: Request list UI elements missing."); return; }
             console.log("Loading requests...");

             const q = query(collection(db, `/artifacts/${appId}/public/data/requests`));
             try {
                 const querySnapshot = await getDocs(q);
                 if (querySnapshot.empty) {
                      if (adminMessage.classList.contains('hidden')) {
                         requestsList.innerHTML = `<p class="text-gray-600 font-semibold col-span-full text-center p-4">No pickup requests found.</p>`;
                         requestsList.classList.remove('hidden');
                      }
                      return;
                 }
                 requestsList.innerHTML = '';
                 const docs = querySnapshot.docs.map(docSnap => ({ ...docSnap.data(), docId: docSnap.id }));
                 
                 docs.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                 docs.forEach(data => {
                     const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString('en-IN') : 'N/A';
                     const selectId = `status-${data.docId}`;
                     const cardHtml = `
                         <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200 flex flex-col space-y-3">
                             <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-green-700">${data.wasteType || 'N/A'}</h3> <span class="text-sm text-gray-500">${date}</span> </div>
                             <p class="text-gray-600"><strong class="text-gray-900">User:</strong> ${data.name || 'N/A'}</p>
                             <p class="text-gray-600"><strong class="text-gray-900">Phone:</strong> ${data.phone || 'N/A'}</p>
                             <p class="text-gray-600"><strong class="text-gray-900">Address:</strong> ${data.address || 'N/A'}</p>
                             <p class="text-gray-600"><strong class="text-gray-900">Quantity:</strong> ${data.quantity || 'N/A'}</p>
                             <p class="text-xs text-gray-400">Req ID: ${data.requestId || 'N/A'}</p>
                             <p class="text-xs text-gray-400">User ID: ${data.userId || 'N/A'}</p>
                             <div class="border-t pt-3 mt-auto">
                                 <label for="${selectId}" class="block text-sm font-medium text-gray-700">Update Status:</label>
                                 <select id="${selectId}" data-docid="${data.docId}" class="status-select w-full mt-1 status-${data.status || 'Submitted'}">
                                     <option value="Submitted" ${data.status === 'Submitted' ? 'selected' : ''}>Submitted</option>
                                     <option value="Collected" ${data.status === 'Collected' ? 'selected' : ''}>Collected</option>
                                     <option value="Approved" ${data.status === 'Approved' ? 'selected' : ''}>Approved</option>
                                     <option value="Rejected" ${data.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                                 </select>
                             </div>
                         </div>`;
                     requestsList.innerHTML += cardHtml;
                 });
                 requestsList.classList.remove('hidden');
                 document.querySelectorAll('.status-select').forEach(select => {
                     select.addEventListener('change', handleStatusChange);
                     select.className = `status-select w-full mt-1 status-${select.value}`;
                 });
             } catch(error) {
                 console.error("Admin Page: Error loading requests:", error);
                 const message = error.code === 'permission-denied' ? "FATAL ERROR: Admin does not have permission to read requests." : `Error loading requests: ${error.message}`;
                 requestsList.innerHTML = `<p class="text-red-600 font-semibold col-span-full text-center p-4">${message}</p>`;
                 requestsList.classList.remove('hidden');
                 showMessage("Error loading requests. Check console.", true);
             } finally {
                 console.log("Finished loading requests.");
             }
        }

        // --- Handle Status Change ---
        async function handleStatusChange(event) {
             if (!db || !(event.target instanceof HTMLSelectElement)) return;
             const selectElement = event.target;
             const newStatus = selectElement.value;
             const docId = selectElement.dataset.docid;
             if (!docId) { console.error("Admin Page: Missing docId."); showMessage("Error: Could not identify request.", true); return; }
             selectElement.className = `status-select w-full mt-1 status-${newStatus}`;
             const requestRef = doc(db, `/artifacts/${appId}/public/data/requests`, docId);
             try {
                 await updateDoc(requestRef, { status: newStatus });
                 console.log(`Admin Page: Updated doc ${docId} to status ${newStatus}`);
                 showMessage(`Status updated to ${newStatus}`);
             } catch (error) {
                 console.error("Admin Page: Error updating status:", error);
                 const message = error.code === 'permission-denied' ? "Error: Admin does not have permission to update." : `Failed to update status: ${error.message}`;
                 showMessage(message, true);
                 const originalValue = [...selectElement.options].find(option => option.defaultSelected)?.value ?? 'Submitted';
                 selectElement.className = `status-select w-full mt-1 status-${originalValue}`;
                 selectElement.value = originalValue;
             }
        }

        // --- Logout ---
        logoutBtn?.addEventListener('click', () => { if (auth) { signOut(auth).catch(error => showMessage("Logout failed: " + error.message, true)); } });

        // --- Admin Menu Toggle Logic ---
        adminMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); adminMenuDropdown?.classList.toggle('hidden'); });
        document.addEventListener('click', (e) => { if (adminMenuDropdown && adminMenuBtn && !adminMenuDropdown.contains(e.target) && !adminMenuBtn.contains(e.target)) { adminMenuDropdown.classList.add('hidden'); } });

    </script>

</body>
</html>